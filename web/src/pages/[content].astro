---
import Base from '../layouts/Base.astro';
import Background from '../components/Background.svelte';
import { apiUrl, forwardedApiHeaders } from '../utils/api';

type ContentSection = {
  heading: string;
  body: string;
};

type ContentPayload = {
  title: string;
  sections: ContentSection[];
};

const FALLBACK_BY_SLUG: Record<string, ContentPayload> = {
  privacy: {
    title: 'Privacy Policy',
    sections: [
      {
        heading: 'Data We Collect',
        body: 'Voidwire stores account identity data, profile inputs, subscription status, and generated readings tied to your account.',
      },
    ],
  },
  terms: {
    title: 'Terms of Service',
    sections: [
      {
        heading: 'Service Scope',
        body: 'Voidwire provides software-generated astrological content for informational and entertainment purposes only.',
      },
    ],
  },
  'billing-policy': {
    title: 'Billing Policy',
    sections: [
      {
        heading: 'Subscriptions',
        body: 'Pro access is subscription-based unless manually overridden by administration for support/testing.',
      },
    ],
  },
  disclaimer: {
    title: 'Disclaimer',
    sections: [
      {
        heading: 'No Professional Advice',
        body: 'Voidwire outputs are generated text and are not a substitute for legal, medical, mental health, or financial advice.',
      },
    ],
  },
};

const slug = String(Astro.params.content || '').trim().toLowerCase();
const fallback = FALLBACK_BY_SLUG[slug] || null;
let pageTitle = fallback?.title || '';
let sections: ContentSection[] = fallback?.sections || [];
let notFound = false;
const apiHeaders = forwardedApiHeaders(Astro.clientAddress);

try {
  const res = await fetch(apiUrl(`/v1/content/${slug}`), { headers: apiHeaders });
  if (res.ok) {
    const data = await res.json();
    if (typeof data?.title === 'string' && data.title.trim()) {
      pageTitle = data.title.trim();
    }
    if (Array.isArray(data?.sections)) {
      const parsed = data.sections
        .map((raw: unknown): ContentSection | null => {
          if (!raw || typeof raw !== 'object') return null;
          const item = raw as Record<string, unknown>;
          const heading = String(item.heading ?? '').trim();
          const body = String(item.body ?? '').trim();
          if (!heading && !body) return null;
          return { heading, body };
        })
        .filter((item: ContentSection | null): item is ContentSection => item !== null);
      if (parsed.length > 0) {
        sections = parsed;
      }
    }
  }
} catch {
  // Keep fallback content if API is unavailable.
}

// No known fallback and no API content â†’ 404
if (!pageTitle && sections.length === 0) {
  notFound = true;
  Astro.response.status = 404;
}

function toParagraphs(body: string): string[] {
  return body
    .split(/\n\n+/)
    .map((line) => line.trim())
    .filter((line) => line.length > 0);
}
---

<Base title={notFound ? 'Signal Lost' : pageTitle} canonicalPath={notFound ? undefined : `/${slug}`}>
  <Background />

  <header class="site-header">
    <h1 class="site-title"><a href="/">VOIDWIRE</a></h1>
    <nav class="site-nav">
      <a href="/archive">Archive</a>
      <a href="/events">Events</a>
      <a href="/about">About</a>
    </nav>
  </header>

  {notFound ? (
    <main class="void-page">
      <div class="void-container">
        <div class="void-sigil">
          <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" class="sigil-svg" aria-hidden="true">
            <circle cx="60" cy="60" r="56" fill="none" stroke="var(--accent)" stroke-width="0.5" opacity="0.3" />
            <circle cx="60" cy="60" r="40" fill="none" stroke="var(--accent)" stroke-width="0.3" opacity="0.2" />
            <circle cx="60" cy="60" r="22" fill="none" stroke="var(--accent)" stroke-width="0.3" opacity="0.15" />
            <line x1="60" y1="2" x2="60" y2="118" stroke="var(--accent)" stroke-width="0.3" opacity="0.12" />
            <line x1="2" y1="60" x2="118" y2="60" stroke="var(--accent)" stroke-width="0.3" opacity="0.12" />
            <line x1="18" y1="18" x2="102" y2="102" stroke="var(--accent)" stroke-width="0.2" opacity="0.08" />
            <line x1="102" y1="18" x2="18" y2="102" stroke="var(--accent)" stroke-width="0.2" opacity="0.08" />
            <circle cx="60" cy="60" r="3" fill="var(--accent)" opacity="0.15" />
          </svg>
        </div>
        <div class="void-code">404</div>
        <h1 class="void-title">The signal fades to silence</h1>
        <p class="void-body">
          This frequency carries no transmission. The coordinates you followed
          lead beyond the edge of the charted wire&mdash;into static, into void.
        </p>
        <div class="void-divider"></div>
        <nav class="void-nav">
          <a href="/">Today&rsquo;s Reading</a>
          <span class="void-sep">&middot;</span>
          <a href="/archive">Archive</a>
          <span class="void-sep">&middot;</span>
          <a href="/events">Events</a>
        </nav>
      </div>
    </main>
  ) : (
    <main class="colophon">
      {sections.map((section) => (
        <section class="content-section">
          {section.heading && <h2>{section.heading}</h2>}
          {toParagraphs(section.body).map((paragraph) => (
            <p>{paragraph}</p>
          ))}
        </section>
      ))}
    </main>
  )}
</Base>

<style>
  .content-section + .content-section {
    margin-top: 3rem;
  }

  /* 404 inline styles */
  .void-page {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - 8rem);
    padding: 2rem 1.5rem;
  }

  .void-container {
    text-align: center;
    max-width: 480px;
  }

  .void-sigil {
    width: 120px;
    height: 120px;
    margin: 0 auto 2.5rem;
    animation: sigil-drift 16s ease-in-out infinite, sigil-fade-in 2s ease-out both;
  }

  .sigil-svg {
    width: 100%;
    height: 100%;
  }

  @keyframes sigil-drift {
    0%, 100% { transform: rotate(0deg); }
    50% { transform: rotate(180deg); }
  }

  @keyframes sigil-fade-in {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
  }

  .void-code {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    letter-spacing: 0.4em;
    color: var(--text-ghost);
    margin-bottom: 1.5rem;
    animation: void-in 1.5s ease-out 0.3s both;
  }

  .void-title {
    font-family: var(--font-body);
    font-size: 2rem;
    font-weight: 400;
    color: var(--text-primary);
    line-height: 1.3;
    margin-bottom: 1.5rem;
    animation: void-in 1.5s ease-out 0.5s both;
  }

  .void-body {
    font-family: var(--font-body);
    font-size: 1.1rem;
    line-height: 1.8;
    color: var(--text-secondary);
    margin-bottom: 2.5rem;
    animation: void-in 1.5s ease-out 0.7s both;
  }

  .void-divider {
    width: 60px;
    height: 1px;
    background: var(--text-ghost);
    margin: 0 auto 2rem;
    animation: void-in 1.5s ease-out 0.9s both;
  }

  .void-nav {
    font-family: var(--font-sans);
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    animation: void-in 1.5s ease-out 1.1s both;
  }

  .void-nav a {
    color: var(--text-muted);
    transition: color 0.3s ease;
  }

  .void-nav a:hover {
    color: var(--accent);
    opacity: 1;
  }

  .void-sep {
    color: var(--text-ghost);
    font-size: 0.5rem;
  }

  @keyframes void-in {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (prefers-reduced-motion: reduce) {
    .void-sigil,
    .void-code,
    .void-title,
    .void-body,
    .void-divider,
    .void-nav {
      animation: none;
    }
  }

  @media (max-width: 768px) {
    .void-title {
      font-size: 1.6rem;
    }

    .void-body {
      font-size: 1rem;
    }
  }
</style>
