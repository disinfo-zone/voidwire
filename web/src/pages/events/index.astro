---
import Base from '../../layouts/Base.astro';
import Background from '../../components/Background.svelte';

const API_URL = process.env.API_URL || import.meta.env.API_URL || 'http://voidwire-api:8000';

interface AstroEvent {
  event_type: string;
  body?: string;
  sign?: string;
  at: string;
  significance?: string;
}

let events: AstroEvent[] = [];
let error: string | null = null;

try {
  const res = await fetch(`${API_URL}/v1/events?limit=50`);
  if (res.ok) {
    const data = await res.json();
    events = data.items || data;
  } else {
    error = `Failed to load events (${res.status})`;
  }
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error';
}

function formatEventType(type: string): string {
  return type.replace(/_/g, ' ');
}

function formatDate(iso: string): string {
  try {
    return new Date(iso).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      timeZoneName: 'short',
    });
  } catch {
    return iso;
  }
}
---

<Base title="Events">
  <Background client:load />

  <header class="site-header">
    <h1 class="site-title"><a href="/">VOIDWIRE</a></h1>
    <nav class="site-nav">
      <a href="/archive">Archive</a>
      <a href="/events">Events</a>
      <a href="/about">About</a>
    </nav>
  </header>

  <main class="page-container">
    <h2 class="page-title">Upcoming Events</h2>

    {error && (
      <div class="status-message">
        <p>Signal disrupted</p>
        <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.6;">{error}</p>
      </div>
    )}

    {!error && events.length === 0 && (
      <div class="status-message">
        <p>No upcoming events detected</p>
      </div>
    )}

    {events.length > 0 && (
      <div>
        {events.map((event) => (
          <div class="event-item">
            <div class="event-type">{formatEventType(event.event_type)}</div>
            <div class="event-detail">
              {event.body && <span>{event.body}</span>}
              {event.body && event.sign && <span> in </span>}
              {event.sign && <span>{event.sign}</span>}
              {event.significance && <span class="event-significance"> &mdash; {event.significance}</span>}
            </div>
            <div class="event-date">{formatDate(event.at)}</div>
          </div>
        ))}
      </div>
    )}
  </main>
</Base>
