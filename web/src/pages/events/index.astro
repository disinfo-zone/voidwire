---
import Base from '../../layouts/Base.astro';
import Background from '../../components/Background.svelte';
import { apiUrl, forwardedApiHeaders } from '../../utils/api';

interface AstroEvent {
  id: string;
  event_type: string;
  body?: string;
  sign?: string;
  at: string;
  significance?: string;
  reading_available?: boolean;
  reading_status?: string;
  reading_title?: string;
  reading_url?: string | null;
}

interface EphemerisPosition {
  sign: string;
  degree: number;
  longitude: number;
  speed_deg_day: number;
  retrograde: boolean;
}

interface LunarData {
  phase_name: string;
  phase_pct: number;
  void_of_course: boolean;
  void_of_course_starts?: string | null;
  next_sign_ingress?: { sign?: string; at?: string } | null;
}

interface StationOrIngress {
  type: string;
  body: string;
  sign?: string | null;
  at: string;
  core_meaning?: string;
}

interface ForwardEvent {
  at: string;
  event: string;
  significance?: string;
  core_meaning?: string | null;
}

interface EphemerisData {
  positions: Record<string, EphemerisPosition>;
  lunar: LunarData;
  aspects: any[];
  stations_and_ingresses: StationOrIngress[];
  forward_ephemeris: ForwardEvent[];
}

interface WeatherDescriptions {
  moon_phase?: string;
  void_of_course?: string;
  retrogrades?: string | null;
  timeline?: string[];
}

let events: AstroEvent[] = [];
let error: string | null = null;
let ephemeris: EphemerisData | null = null;
let weather: WeatherDescriptions | null = null;
let siteTimezone = 'UTC';
const apiHeaders = forwardedApiHeaders(Astro.clientAddress);

try {
  const cfgRes = await fetch(apiUrl('/v1/site/config'), { headers: apiHeaders });
  if (cfgRes.ok) {
    const cfg = await cfgRes.json();
    siteTimezone = String(cfg?.timezone || 'UTC') || 'UTC';
  }
} catch {}

// Fetch events, ephemeris, and weather in parallel
const [eventsResult, ephemerisResult, weatherResult] = await Promise.allSettled([
  fetch(apiUrl('/v1/events?limit=50'), { headers: apiHeaders }),
  fetch(apiUrl('/v1/ephemeris/today'), { headers: apiHeaders }),
  fetch(apiUrl('/v1/ephemeris/today/weather'), { headers: apiHeaders }),
]);

if (eventsResult.status === 'fulfilled') {
  const res = eventsResult.value;
  if (res.ok) {
    const data = await res.json();
    events = data.items || data;
  } else {
    error = `Failed to load events (${res.status})`;
  }
} else {
  error = eventsResult.reason instanceof Error ? eventsResult.reason.message : 'Unknown error';
}

if (ephemerisResult.status === 'fulfilled' && ephemerisResult.value.ok) {
  try {
    ephemeris = await ephemerisResult.value.json();
  } catch {}
}

if (weatherResult.status === 'fulfilled' && weatherResult.value.ok) {
  try {
    weather = await weatherResult.value.json();
  } catch {}
}

function formatEventType(type: string): string {
  return type.replace(/_/g, ' ');
}

function formatPhaseName(phase: string): string {
  return phase.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
}

function formatDate(iso: string): string {
  try {
    return new Date(iso).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      timeZone: siteTimezone,
      timeZoneName: 'short',
    });
  } catch {
    return iso;
  }
}

function formatShortDate(iso: string): string {
  try {
    return new Date(iso).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      timeZone: siteTimezone,
    });
  } catch {
    return iso;
  }
}

function formatDateOnly(iso: string): string {
  try {
    return new Date(iso).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      timeZone: siteTimezone,
    });
  } catch {
    return iso;
  }
}

function formatTimelineDate(iso: string, isMajor: boolean): string {
  if (isMajor) return formatShortDate(iso);
  return formatDateOnly(iso);
}

// Tooltip lookup maps
const PHASE_TIPS: Record<string, string> = {
  new_moon: 'Seed moment \u2014 set intentions, begin inner work',
  waxing_crescent: 'Emerging momentum \u2014 take the first visible steps',
  first_quarter: 'Decision point \u2014 push through resistance',
  waxing_gibbous: 'Refine and adjust \u2014 building toward fullness',
  full_moon: 'Culmination and clarity \u2014 what was hidden is illuminated',
  waning_gibbous: 'Gratitude and sharing \u2014 distribute what you have gathered',
  last_quarter: 'Release and let go \u2014 clear what no longer serves',
  waning_crescent: 'Rest and surrender \u2014 the cycle completes in stillness',
};

const RETRO_TIPS: Record<string, string> = {
  Mercury: 'Communication tangles, tech glitches, revisiting old conversations',
  Venus: 'Reassessing relationships, values, and what you find beautiful',
  Mars: 'Redirected energy, revisiting old conflicts or projects',
  Jupiter: 'Internal growth, questioning beliefs and ambitions',
  Saturn: 'Reviewing commitments, restructuring responsibilities',
  Uranus: 'Internalizing change, quiet rebellion brewing',
  Neptune: 'Dissolving illusions, spiritual course-correction',
  Pluto: 'Deep internal transformation, power dynamics surface',
  Chiron: 'Old wounds resurface for deeper healing',
};

// Derived data
const retroPlanets = ephemeris
  ? Object.entries(ephemeris.positions)
      .filter(([name, pos]) => pos.retrograde && !['sun', 'moon', 'north_node'].includes(name.toLowerCase()))
      .map(([name, pos]) => ({
        name: name.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase()),
        sign: pos.sign,
      }))
  : [];

// Only separate eclipses when ephemeris data is available to display them
const eclipseEvents = ephemeris
  ? events.filter((e) => e.event_type === 'lunar_eclipse' || e.event_type === 'solar_eclipse')
  : [];
const nonEclipseEvents = ephemeris
  ? events.filter((e) => e.event_type !== 'lunar_eclipse' && e.event_type !== 'solar_eclipse')
  : events;

// Moon sign from positions
const moonPos = ephemeris?.positions?.moon || ephemeris?.positions?.Moon;
const moonSign = moonPos?.sign || '';

// Phase data attribute for CSS moon visual
function phaseDataAttr(phaseName: string): string {
  const map: Record<string, string> = {
    new_moon: 'new', waxing_crescent: 'wax-crescent', first_quarter: 'first-quarter',
    waxing_gibbous: 'wax-gibbous', full_moon: 'full', waning_gibbous: 'wan-gibbous',
    last_quarter: 'last-quarter', waning_crescent: 'wan-crescent',
  };
  return map[phaseName] || 'new';
}
---

<Base title="Celestial Weather">
  <Background />

  <header class="site-header">
    <h1 class="site-title"><a href="/">VOIDWIRE</a></h1>
    <nav class="site-nav">
      <a href="/archive">Archive</a>
      <a href="/events">Events</a>
      <a href="/about">About</a>
    </nav>
  </header>

  <main class="page-container">
    <h2 class="page-title">Celestial Weather</h2>

    {ephemeris && (
      <div class="celestial-weather">

        <!-- Moon Phase -->
        <div class="weather-card">
          <div class="weather-label" data-tip="The Moon's current phase and sign \u2014 sets the emotional backdrop for the day">Current Moon</div>
          <div class="moon-phase-row">
            <div class="moon-disc" data-phase={phaseDataAttr(ephemeris.lunar.phase_name)}></div>
            <div class="moon-info">
              <div class="moon-phase-name" data-tip={PHASE_TIPS[ephemeris.lunar.phase_name] || ''}>{formatPhaseName(ephemeris.lunar.phase_name)}</div>
              <div class="moon-detail">
                {Math.round((1 - Math.cos(ephemeris.lunar.phase_pct * 2 * Math.PI)) / 2 * 100)}% illuminated
                {moonSign && <span> &middot; Moon in {moonSign}</span>}
              </div>
              {weather?.moon_phase && (
                <div class="weather-description">{weather.moon_phase}</div>
              )}
            </div>
          </div>
        </div>

        <!-- Void of Course -->
        <div class="weather-card">
          <div class="weather-label" data-tip="When the Moon makes no more major aspects before changing signs \u2014 a liminal pause">Void of Course Moon</div>
          {ephemeris.lunar.void_of_course ? (
            <div class="voc-row">
              <span class="voc-badge voc-active" data-tip="The Moon is void of course \u2014 traditionally a poor time to start new ventures">Active</span>
              <span class="voc-note">{weather?.void_of_course || 'Avoid initiating major actions \u2014 rest, reflect, review'}</span>
            </div>
          ) : (
            <div class="voc-row">
              <span class="voc-badge voc-clear" data-tip="The Moon is actively aspecting \u2014 intentions carry forward clearly">Clear</span>
              {weather?.void_of_course ? (
                <span class="voc-note">{weather.void_of_course}</span>
              ) : ephemeris.lunar.next_sign_ingress?.at ? (
                <span class="voc-next">Moon enters {ephemeris.lunar.next_sign_ingress.sign || 'next sign'} &middot; {formatShortDate(ephemeris.lunar.next_sign_ingress.at)}</span>
              ) : null}
            </div>
          )}
        </div>

        <!-- Retrograde Tracker -->
        {retroPlanets.length > 0 && (
          <div class="weather-card">
            <div class="weather-label" data-tip="Planets appearing to move backward \u2014 their themes turn inward for review">Retrograde Planets</div>
            <div class="retro-chips">
              {retroPlanets.map((p) => (
                <span class="retro-chip" data-tip={RETRO_TIPS[p.name] || ''}>&#8478; {p.name} in {p.sign}</span>
              ))}
            </div>
            {weather?.retrogrades && (
              <div class="weather-description retro-summary">{weather.retrogrades}</div>
            )}
          </div>
        )}

        <!-- Transit Timeline -->
        {(ephemeris.stations_and_ingresses.length > 0 || ephemeris.forward_ephemeris.length > 0) && (
          <div class="weather-card">
            <div class="weather-label" data-tip="Key planetary movements over the next 5 days">Transit Timeline</div>
            <div class="timeline">
              {ephemeris.stations_and_ingresses.map((si, i) => {
                const isMajor = si.type.includes('station');
                const meaning = weather?.timeline?.[i] ?? si.core_meaning;
                return (
                  <div class={`timeline-item ${isMajor ? 'timeline-major' : ''}`}>
                    <div class="timeline-event">{formatEventType(si.type)}: {si.body}{si.sign ? ` in ${si.sign}` : ''}</div>
                    <div class="timeline-date">{formatTimelineDate(si.at, isMajor)}</div>
                    {meaning && <div class="timeline-meaning">{meaning}</div>}
                  </div>
                );
              })}
              {ephemeris.forward_ephemeris.map((fe, j) => {
                const isMajor = fe.significance === 'major';
                const meaning = weather?.timeline?.[ephemeris.stations_and_ingresses.length + j] ?? fe.core_meaning;
                return (
                  <div class={`timeline-item ${isMajor ? 'timeline-major' : ''}`}>
                    <div class="timeline-event">{fe.event}</div>
                    <div class="timeline-date">{formatTimelineDate(fe.at, isMajor)}</div>
                    {meaning && <div class="timeline-meaning">{meaning}</div>}
                  </div>
                );
              })}
            </div>
          </div>
        )}

        <!-- Eclipses -->
        {eclipseEvents.length > 0 && (
          <div class="weather-card">
            <div class="weather-label" data-tip="Eclipse season \u2014 potent windows of change and revelation">Upcoming Eclipses</div>
            {eclipseEvents.map((event) => (
              <div class="eclipse-item">
                <div class="eclipse-type">{formatEventType(event.event_type)}</div>
                <div class="eclipse-detail">
                  {event.body && <span>{event.body}</span>}
                  {event.body && event.sign && <span> in </span>}
                  {event.sign && <span>{event.sign}</span>}
                </div>
                <div class="eclipse-date">{formatDate(event.at)}</div>
                {event.reading_available && (
                  <div class="event-reading-link">
                    <a href={event.reading_url || `/events/${event.id}`}>Read Event Reading</a>
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    )}

    <!-- Event Articles -->
    {error && (
      <div class="status-message">
        <p>Signal disrupted</p>
        <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.6;">{error}</p>
      </div>
    )}

    {!error && nonEclipseEvents.length === 0 && events.length === 0 && (
      <div class="status-message">
        <p>No upcoming events detected</p>
      </div>
    )}

    {nonEclipseEvents.length > 0 && (
      <div class="events-section">
        <div class="weather-label" data-tip="Scheduled astronomical events with available readings">Event Articles</div>
        <div>
          {nonEclipseEvents.map((event) => (
            <div class="event-item">
              <div class="event-type">{formatEventType(event.event_type)}</div>
              <div class="event-detail">
                {event.body && <span>{event.body}</span>}
                {event.body && event.sign && <span> in </span>}
                {event.sign && <span>{event.sign}</span>}
                {event.significance && <span class="event-significance"> &mdash; {event.significance}</span>}
              </div>
              <div class="event-date">{formatDate(event.at)}</div>
              {event.reading_available && (
                <div class="event-reading-link">
                  <a href={event.reading_url || `/events/${event.id}`}>Read Event Reading</a>
                  {event.reading_title && <span class="event-reading-title">- {event.reading_title}</span>}
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
    )}
  </main>
</Base>

<style>
  /* Celestial Weather Container */
  .celestial-weather {
    display: flex;
    flex-direction: column;
    gap: 0;
    margin-bottom: 2rem;
  }

  .weather-card {
    padding: 1.2rem 0;
    border-bottom: 1px solid var(--text-ghost);
  }

  .weather-card:first-child {
    padding-top: 0;
  }

  .weather-label {
    font-family: var(--font-sans);
    font-size: 0.6rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 0.6rem;
  }

  .weather-label[data-tip] {
    cursor: help;
  }

  /* Weather description (LLM text under sections) */
  .weather-description {
    font-family: var(--font-sans);
    font-size: 0.72rem;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-top: 0.35rem;
    font-style: italic;
  }

  .retro-summary {
    margin-top: 0.6rem;
  }

  /* Moon Phase */
  .moon-phase-row {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .moon-disc {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
  }

  .moon-disc::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: var(--text-secondary);
  }

  .moon-disc::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
  }

  .moon-disc[data-phase="new"]::before {
    background: var(--void);
  }

  .moon-disc[data-phase="new"]::after {
    background: var(--void);
  }

  .moon-disc[data-phase="wax-crescent"]::after {
    background: linear-gradient(to left, transparent 35%, var(--void) 65%);
  }

  .moon-disc[data-phase="first-quarter"]::after {
    background: linear-gradient(to left, transparent 50%, var(--void) 50%);
  }

  .moon-disc[data-phase="wax-gibbous"]::after {
    background: linear-gradient(to right, transparent 65%, var(--void) 100%);
    opacity: 0.6;
  }

  .moon-disc[data-phase="full"]::after {
    background: transparent;
  }

  .moon-disc[data-phase="wan-gibbous"]::after {
    background: linear-gradient(to left, transparent 65%, var(--void) 100%);
    opacity: 0.6;
  }

  .moon-disc[data-phase="last-quarter"]::after {
    background: linear-gradient(to right, transparent 50%, var(--void) 50%);
  }

  .moon-disc[data-phase="wan-crescent"]::after {
    background: linear-gradient(to right, transparent 35%, var(--void) 65%);
  }

  .moon-info {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }

  .moon-phase-name {
    font-family: var(--font-body);
    font-size: 1.1rem;
    color: var(--text-primary);
  }

  .moon-phase-name[data-tip] {
    cursor: help;
  }

  .moon-detail {
    font-family: var(--font-sans);
    font-size: 0.72rem;
    color: var(--text-secondary);
  }

  /* Void of Course */
  .voc-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .voc-badge {
    font-family: var(--font-sans);
    font-size: 0.62rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.2em 0.6em;
    border-radius: 3px;
  }

  .voc-badge[data-tip] {
    cursor: help;
  }

  .voc-active {
    background: rgba(224, 112, 96, 0.15);
    color: #e07060;
    border: 1px solid rgba(224, 112, 96, 0.3);
  }

  .voc-clear {
    background: rgba(80, 168, 104, 0.1);
    color: #50a868;
    border: 1px solid rgba(80, 168, 104, 0.2);
  }

  .voc-note {
    font-family: var(--font-sans);
    font-size: 0.72rem;
    color: var(--text-secondary);
    font-style: italic;
  }

  .voc-next {
    font-family: var(--font-sans);
    font-size: 0.72rem;
    color: var(--text-secondary);
  }

  /* Retrograde Chips */
  .retro-chips {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .retro-chip {
    font-family: var(--font-sans);
    font-size: 0.68rem;
    font-weight: 500;
    color: var(--text-secondary);
    padding: 0.25em 0.6em;
    border: 1px solid var(--text-ghost);
    border-radius: 3px;
    white-space: nowrap;
  }

  .retro-chip[data-tip] {
    cursor: help;
  }

  /* Transit Timeline */
  .timeline {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .timeline-item {
    padding: 0.6rem 0 0.6rem 0.8rem;
    border-left: 2px solid var(--text-ghost);
    position: relative;
  }

  .timeline-item:first-child {
    padding-top: 0;
  }

  .timeline-item:last-child {
    padding-bottom: 0;
  }

  .timeline-major {
    border-left-color: var(--accent);
  }

  .timeline-event {
    font-family: var(--font-body);
    font-size: 0.95rem;
    color: var(--text-primary);
    text-transform: capitalize;
  }

  .timeline-date {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    color: var(--text-muted);
    margin-top: 0.15rem;
  }

  .timeline-meaning {
    font-family: var(--font-sans);
    font-size: 0.72rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
    line-height: 1.5;
  }

  /* Eclipse Items */
  .eclipse-item {
    padding: 0.6rem 0;
  }

  .eclipse-item + .eclipse-item {
    border-top: 1px solid var(--text-ghost);
  }

  .eclipse-type {
    font-family: var(--font-sans);
    font-size: 0.62rem;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 0.2rem;
  }

  .eclipse-detail {
    font-family: var(--font-body);
    font-size: 0.95rem;
    color: var(--text-primary);
  }

  .eclipse-date {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    color: var(--text-muted);
    margin-top: 0.15rem;
  }

  /* Event Articles Section */
  .events-section {
    margin-top: 1.5rem;
  }

  .events-section .weather-label {
    margin-bottom: 0.8rem;
  }

  /* Event Items */
  .event-item {
    padding: 1rem 0;
    border-bottom: 1px solid var(--text-ghost);
  }

  .event-type {
    font-family: var(--font-sans);
    font-size: 0.62rem;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 0.2rem;
  }

  .event-detail {
    font-family: var(--font-body);
    font-size: 0.95rem;
    color: var(--text-primary);
  }

  .event-significance {
    color: var(--text-secondary);
  }

  .event-date {
    font-family: var(--font-mono);
    font-size: 0.65rem;
    color: var(--text-muted);
    margin-top: 0.15rem;
  }

  .event-reading-link {
    margin-top: 0.8rem;
    font-family: var(--font-sans);
    font-size: 0.72rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .event-reading-link a {
    color: var(--accent);
    text-decoration: none;
  }

  .event-reading-link a:hover {
    text-decoration: underline;
  }

  .event-reading-title {
    color: var(--text-muted);
    margin-left: 0.5rem;
    text-transform: none;
    letter-spacing: 0;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .moon-disc {
      width: 44px;
      height: 44px;
    }

    .moon-phase-name {
      font-size: 1rem;
    }

    .weather-card {
      padding: 1rem 0;
    }

    .timeline-meaning {
      font-size: 0.68rem;
    }
  }

  @media (max-width: 400px) {
    .moon-phase-row {
      gap: 0.75rem;
    }

    .moon-disc {
      width: 36px;
      height: 36px;
    }

    .voc-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.4rem;
    }

    .retro-chips {
      gap: 0.35rem;
    }

    .retro-chip {
      font-size: 0.62rem;
    }
  }

  /* Tooltip popup */
  :global(.tip-popup) {
    position: fixed;
    z-index: 2000;
    max-width: 280px;
    padding: 0.5rem 0.75rem;
    background: #181c2a;
    border: 1px solid rgba(214, 175, 114, 0.2);
    border-radius: 6px;
    font-family: var(--font-sans);
    font-size: 0.68rem;
    line-height: 1.45;
    color: var(--text-secondary);
    pointer-events: none;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
  }
</style>

<script>
  // --- Custom tooltip system (works on hover + tap) ---
  (() => {
    const tip = document.createElement('div');
    tip.className = 'tip-popup';
    tip.style.display = 'none';
    document.body.appendChild(tip);

    let activeTarget: Element | null = null;
    let hideTimer: number | null = null;

    function showTip(target: Element) {
      const text = target.getAttribute('data-tip');
      if (!text) return;
      if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
      activeTarget = target;
      tip.textContent = text;
      tip.style.display = 'block';

      const rect = target.getBoundingClientRect();
      const tipRect = tip.getBoundingClientRect();
      let left = rect.left + rect.width / 2 - tipRect.width / 2;
      let top = rect.top - tipRect.height - 8;

      // Flip below if no room above
      if (top < 4) top = rect.bottom + 8;
      // Clamp horizontal
      left = Math.max(8, Math.min(left, window.innerWidth - tipRect.width - 8));

      tip.style.left = `${left}px`;
      tip.style.top = `${top}px`;
    }

    function hideTip() {
      tip.style.display = 'none';
      activeTarget = null;
    }

    function scheduledHide() {
      hideTimer = window.setTimeout(hideTip, 120);
    }

    // Desktop: hover
    document.addEventListener('mouseenter', (e) => {
      const target = (e.target as Element)?.closest?.('[data-tip]');
      if (target && target.getAttribute('data-tip')) showTip(target);
    }, true);
    document.addEventListener('mouseleave', (e) => {
      const target = (e.target as Element)?.closest?.('[data-tip]');
      if (target && target === activeTarget) scheduledHide();
    }, true);

    // Mobile: tap to show, tap elsewhere to dismiss
    document.addEventListener('click', (e) => {
      const target = (e.target as Element)?.closest?.('[data-tip]');
      if (target && target.getAttribute('data-tip')) {
        if (activeTarget === target) {
          hideTip();
        } else {
          showTip(target);
        }
      } else {
        if (activeTarget) hideTip();
      }
    });
  })();
</script>
