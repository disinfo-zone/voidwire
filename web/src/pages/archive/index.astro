---
import Base from '../../layouts/Base.astro';
import Background from '../../components/Background.svelte';
import { apiUrl, forwardedApiHeaders } from '../../utils/api';
const currentPage = Number(Astro.url.searchParams.get('page') || '1');
const perPage = 30;

let readings: Array<{ date_context: string; title: string }> = [];
let error: string | null = null;
let hasMore = false;
const apiHeaders = forwardedApiHeaders(Astro.clientAddress);

try {
  const res = await fetch(apiUrl(`/v1/archive?page=${currentPage}&per_page=${perPage + 1}`), {
    headers: apiHeaders,
  });
  if (res.ok) {
    const data = await res.json();
    const items = data.items || data;
    hasMore = items.length > perPage;
    readings = items.slice(0, perPage);
  } else {
    error = `Failed to load archive (${res.status})`;
  }
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error';
}
---

<Base title="Archive">
  <Background />

  <header class="site-header">
    <h1 class="site-title"><a href="/">VOIDWIRE</a></h1>
    <nav class="site-nav">
      <a href="/archive">Archive</a>
      <a href="/events">Events</a>
      <a href="/about">About</a>
    </nav>
  </header>

  <main class="page-container">
    <h2 class="page-title">Archive</h2>

    {error && (
      <div class="status-message">
        <p>Signal disrupted</p>
        <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.6;">{error}</p>
      </div>
    )}

    {!error && readings.length === 0 && (
      <div class="status-message">
        <p>No transmissions archived yet</p>
      </div>
    )}

    {readings.length > 0 && (
      <ul class="archive-list">
        {readings.map((reading) => (
          <li class="archive-item">
            <a href={`/reading/${reading.date_context}`} class="archive-title">
              {reading.title}
            </a>
            <span class="archive-date">{reading.date_context}</span>
          </li>
        ))}
      </ul>
    )}

    {(currentPage > 1 || hasMore) && (
      <nav class="pagination">
        {currentPage > 1 ? (
          <a href={`/archive?page=${currentPage - 1}`} class="pagination-link">&larr; Newer</a>
        ) : (
          <span class="pagination-disabled">&larr; Newer</span>
        )}
        <span class="pagination-current">Page {currentPage}</span>
        {hasMore ? (
          <a href={`/archive?page=${currentPage + 1}`} class="pagination-link">Older &rarr;</a>
        ) : (
          <span class="pagination-disabled">Older &rarr;</span>
        )}
      </nav>
    )}
  </main>
</Base>
