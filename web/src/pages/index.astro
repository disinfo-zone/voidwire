---
import Base from '../layouts/Base.astro';
import Reading from '../components/Reading.astro';

const API_URL = import.meta.env.API_URL || 'http://api:8000';

let reading = null;
let error = null;
let notFound = false;

try {
  const res = await fetch(`${API_URL}/v1/reading/today`);
  if (res.ok) {
    reading = await res.json();
  } else if (res.status === 404) {
    notFound = true;
  } else {
    error = `Unexpected status: ${res.status}`;
  }
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error';
}
---

<Base>
  <header class="site-header">
    <h1 class="site-title"><a href="/">VOIDWIRE</a></h1>
    <nav class="site-nav">
      <a href="/archive">Archive</a>
      <a href="/events">Events</a>
      <a href="/about">About</a>
    </nav>
  </header>

  <main>
    {reading && (
      <Reading
        title={reading.title}
        body={reading.body}
        date_context={reading.date_context}
        word_count={reading.word_count}
        has_extended={reading.has_extended}
      />
    )}

    {notFound && (
      <div class="status-message">
        <div class="status-icon">&#x2237;</div>
        <p>No transmission today</p>
        <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.6;">The wire is silent. Check the archive for past readings.</p>
      </div>
    )}

    {error && (
      <div class="status-message">
        <div class="status-icon">&#x2302;</div>
        <p>Signal disrupted</p>
        <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.6;">The transmission could not be received. Try again shortly.</p>
      </div>
    )}
  </main>
</Base>
