---
import Base from '../layouts/Base.astro';
import Background from '../components/Background.svelte';
---

<Base title="Login">
  <Background />

  <header class="site-header">
    <div class="site-title"><a href="/">VOIDWIRE</a></div>
    <nav class="site-nav">
      <a href="/archive">Archive</a>
      <a href="/events">Events</a>
      <a href="/about">About</a>
    </nav>
  </header>

  <main>
    <div class="auth-container">
      <h1 class="auth-title">Login</h1>
      <p class="auth-subtitle">Access your personalized readings</p>
      <div id="query-message" class="success-message" style="display: none;"></div>

      <form id="login-form" class="auth-form">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required autocomplete="email" />
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required autocomplete="current-password" />
        </div>

        <div id="error-message" class="error-message" style="display: none;"></div>

        <button type="submit" class="auth-button">Login</button>
      </form>

      <p class="forgot-link"><a href="#" id="forgot-password-link">Forgot password?</a></p>
      <p class="forgot-link"><a href="/verify-email">Need a new verification link?</a></p>
      <div id="reset-panel" style="display: none; margin-top: 1rem;">
        <h2 class="modal-title" style="margin-bottom: 0.8rem;">Set New Password</h2>
        <form id="reset-form" class="auth-form">
          <div class="form-group">
            <label for="reset-password">New Password</label>
            <input type="password" id="reset-password" minlength="8" required />
          </div>
          <button type="submit" class="auth-button">Reset Password</button>
        </form>
      </div>

      <div id="oauth-section" style="display: none;">
        <div class="auth-divider"><span>or continue with</span></div>
        <div class="oauth-buttons">
          <div id="oauth-google-button" class="oauth-google-slot" style="display: none;"></div>
          <button type="button" id="oauth-apple-button" class="oauth-button oauth-apple" style="display: none;">
            <span class="oauth-apple-logo" aria-hidden="true">
              <svg viewBox="0 0 24 24" role="img" focusable="false">
                <path d="M16.7 12.9c0-2.6 2.1-3.9 2.2-4-.1-.1-1.3-1.9-3.2-1.9-1.4 0-2.4.8-3.1.8-.7 0-1.8-.8-2.9-.8-1.5 0-2.8.9-3.6 2.2-1.5 2.6-.4 6.6 1.1 8.8.7 1.1 1.6 2.2 2.8 2.2 1.1 0 1.6-.7 3-.7 1.4 0 1.8.7 3 .7 1.2 0 2-.9 2.7-2 .8-1.1 1.1-2.2 1.1-2.2 0-.1-2.1-.8-2.1-3.1zM15 5.6c.6-.8 1-1.8.9-2.9-.9.1-2 .6-2.7 1.4-.6.7-1.1 1.8-1 2.9 1 .1 2-.5 2.8-1.4z"></path>
              </svg>
            </span>
            <span>Continue with Apple</span>
          </button>
        </div>
      </div>

      <p class="auth-link">Don't have an account? <a href="/register">Register</a></p>
    </div>

    <!-- Forgot password modal -->
    <div id="forgot-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <h2 class="modal-title">Reset Password</h2>
        <form id="forgot-form">
          <div class="form-group">
            <label for="forgot-email">Email</label>
            <input type="email" id="forgot-email" required />
          </div>
          <div id="forgot-message" class="success-message" style="display: none;"></div>
          <button type="submit" class="auth-button">Send Reset Link</button>
          <button type="button" id="forgot-cancel" class="cancel-button">Cancel</button>
        </form>
      </div>
    </div>
  </main>
</Base>

<script>
  import { setToken } from '../utils/auth';

  type OAuthProviders = {
    google?: { enabled?: boolean; client_id?: string };
    apple?: { enabled?: boolean; client_id?: string };
  };

  function loadExternalScript(src: string, isReady: () => boolean): Promise<void> {
    return new Promise((resolve, reject) => {
      if (isReady()) {
        resolve();
        return;
      }
      const selector = `script[data-oauth-src="${src}"]`;
      let script = document.querySelector(selector) as HTMLScriptElement | null;

      const resolveWhenReady = () => {
        if (isReady()) {
          if (script) {
            script.dataset.loaded = 'true';
          }
          resolve();
          return;
        }
        window.setTimeout(() => {
          if (isReady()) {
            if (script) {
              script.dataset.loaded = 'true';
            }
            resolve();
            return;
          }
          reject(new Error(`Failed to initialize ${src}`));
        }, 100);
      };

      if (script) {
        if (script.dataset.loaded === 'true') {
          resolveWhenReady();
          return;
        }
        script.addEventListener('load', resolveWhenReady, { once: true });
        script.addEventListener('error', () => reject(new Error(`Failed to load ${src}`)), {
          once: true,
        });
        return;
      }

      script = document.createElement('script');
      script.src = src;
      script.async = true;
      script.defer = true;
      script.dataset.oauthSrc = src;
      script.addEventListener('load', resolveWhenReady, { once: true });
      script.addEventListener('error', () => reject(new Error(`Failed to load ${src}`)), {
        once: true,
      });
      document.head.appendChild(script);
    });
  }

  async function completeOauthLogin(path: string, payload: Record<string, unknown>): Promise<void> {
    const res = await fetch(path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data?.detail || 'OAuth login failed');
    }
    const data = await res.json();
    setToken(data.access_token);
    window.location.href = '/dashboard';
  }

  function initLoginPage(): void {
    if (window.location.pathname !== '/login') return;

    const form = document.getElementById('login-form') as HTMLFormElement | null;
    const errorEl = document.getElementById('error-message') as HTMLDivElement | null;
    const queryMessageEl = document.getElementById('query-message') as HTMLDivElement | null;
    const resetPanel = document.getElementById('reset-panel') as HTMLDivElement | null;
    const resetForm = document.getElementById('reset-form') as HTMLFormElement | null;
    const oauthSectionEl = document.getElementById('oauth-section') as HTMLDivElement | null;
    const googleButtonMount = document.getElementById('oauth-google-button') as HTMLDivElement | null;
    const appleButtonEl = document.getElementById('oauth-apple-button') as HTMLButtonElement | null;
    const forgotLink = document.getElementById('forgot-password-link') as HTMLAnchorElement | null;
    const forgotModal = document.getElementById('forgot-modal') as HTMLDivElement | null;
    const forgotForm = document.getElementById('forgot-form') as HTMLFormElement | null;
    const forgotCancel = document.getElementById('forgot-cancel') as HTMLButtonElement | null;
    const forgotMessage = document.getElementById('forgot-message') as HTMLDivElement | null;
    if (!form || !errorEl || !queryMessageEl || !resetPanel) return;

    const params = new URLSearchParams(window.location.search);
    const verifyToken = params.get('verify_token');
    const resetToken = params.get('reset_token');
    let oauthInFlight = false;

    function showAuthError(message: string): void {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    function clearAuthError(): void {
      errorEl.style.display = 'none';
    }

    async function handleQueryTokens() {
      if (verifyToken) {
        try {
          const res = await fetch('/v1/user/auth/verify-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: verifyToken }),
          });
          if (!res.ok) {
            const payload = await res.json().catch(() => ({}));
            throw new Error(payload?.detail || 'Verification failed');
          }
          queryMessageEl.textContent = 'Email verified successfully. You can now log in.';
          queryMessageEl.style.display = 'block';
        } catch (err) {
          queryMessageEl.textContent = err instanceof Error ? err.message : 'Verification failed';
          queryMessageEl.style.display = 'block';
        }
      }

      if (resetToken) {
        resetPanel.style.display = 'block';
      }
    }

    async function setupGoogleOauth(clientId: string): Promise<void> {
      if (!googleButtonMount) return;
      await loadExternalScript(
        'https://accounts.google.com/gsi/client',
        () => Boolean((window as any).google?.accounts?.id),
      );
      const googleApi = (window as any).google;
      if (!googleApi?.accounts?.id) {
        throw new Error('Google OAuth SDK failed to load');
      }
      googleButtonMount.style.display = 'block';
      googleButtonMount.style.visibility = 'hidden';
      googleButtonMount.innerHTML = '';
      googleApi.accounts.id.initialize({
        client_id: clientId,
        callback: async (response: any) => {
          const credential = String(response?.credential || '').trim();
          if (!credential) {
            showAuthError('Google sign-in did not return a credential');
            return;
          }
          if (oauthInFlight) return;
          oauthInFlight = true;
          clearAuthError();
          try {
            await completeOauthLogin('/v1/user/auth/oauth/google', { id_token: credential });
          } catch (err) {
            showAuthError(err instanceof Error ? err.message : 'Google sign-in failed');
          } finally {
            oauthInFlight = false;
          }
        },
      });
      googleApi.accounts.id.renderButton(googleButtonMount, {
        theme: 'outline',
        size: 'large',
        text: 'continue_with',
        width: 344,
      });
      window.requestAnimationFrame(() => {
        window.requestAnimationFrame(() => {
          googleButtonMount.style.visibility = 'visible';
        });
      });
    }

    async function setupAppleOauth(clientId: string): Promise<void> {
      if (!appleButtonEl) return;
      await loadExternalScript(
        'https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js',
        () => Boolean((window as any).AppleID?.auth),
      );
      const appleApi = (window as any).AppleID;
      if (!appleApi?.auth) {
        throw new Error('Apple OAuth SDK failed to load');
      }
      appleApi.auth.init({
        clientId,
        scope: 'name email',
        redirectURI: `${window.location.origin}/login`,
        usePopup: true,
      });
      appleButtonEl.style.display = 'block';
      appleButtonEl.onclick = async () => {
        if (oauthInFlight) return;
        oauthInFlight = true;
        clearAuthError();
        try {
          const authResponse = await appleApi.auth.signIn();
          const code = String(authResponse?.authorization?.code || '').trim();
          if (!code) {
            throw new Error('Apple sign-in did not return an authorization code');
          }
          await completeOauthLogin('/v1/user/auth/oauth/apple', { authorization_code: code });
        } catch (err: any) {
          if (String(err?.error || '').toLowerCase() === 'popup_closed_by_user') {
            showAuthError('Apple sign-in was cancelled');
          } else {
            showAuthError(err instanceof Error ? err.message : 'Apple sign-in failed');
          }
        } finally {
          oauthInFlight = false;
        }
      };
    }

    async function loadOauthState() {
      try {
        const res = await fetch('/v1/user/auth/oauth/providers');
        if (!res.ok) return;
        const providers = (await res.json()) as OAuthProviders;
        const googleEnabled = Boolean(providers?.google?.enabled);
        const appleEnabled = Boolean(providers?.apple?.enabled);
        if (!googleEnabled && !appleEnabled) return;
        if (oauthSectionEl) {
          oauthSectionEl.style.display = 'block';
        }
        const oauthSetupTasks: Array<Promise<void>> = [];
        if (googleEnabled) {
          const googleClientId = String(providers?.google?.client_id || '').trim();
          if (googleClientId) {
            oauthSetupTasks.push(setupGoogleOauth(googleClientId));
          } else {
            showAuthError('Google OAuth is enabled but missing client ID');
          }
        }
        if (appleEnabled) {
          const appleClientId = String(providers?.apple?.client_id || '').trim();
          if (appleClientId) {
            oauthSetupTasks.push(setupAppleOauth(appleClientId));
          } else {
            showAuthError('Apple OAuth is enabled but missing client ID');
          }
        }
        await Promise.allSettled(oauthSetupTasks);
      } catch {
        // Leave OAuth section hidden when provider status cannot be loaded.
      }
    }

    void handleQueryTokens();
    void loadOauthState();

    form.onsubmit = async (e) => {
      e.preventDefault();
      clearAuthError();

      const email = (document.getElementById('email') as HTMLInputElement).value;
      const password = (document.getElementById('password') as HTMLInputElement).value;

      try {
        const res = await fetch('/v1/user/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.detail || 'Login failed');
        }

        const data = await res.json();
        setToken(data.access_token);
        window.location.href = '/dashboard';
      } catch (err) {
        showAuthError(err instanceof Error ? err.message : 'Login failed');
      }
    };

    if (forgotLink && forgotModal) {
      forgotLink.onclick = (e) => {
        e.preventDefault();
        forgotModal.style.display = 'flex';
      };
    }

    if (forgotCancel && forgotModal) {
      forgotCancel.onclick = () => {
        forgotModal.style.display = 'none';
      };
    }

    if (forgotForm && forgotMessage) {
      forgotForm.onsubmit = async (e) => {
        e.preventDefault();
        const email = (document.getElementById('forgot-email') as HTMLInputElement).value;

        await fetch('/v1/user/auth/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email }),
        });

        forgotMessage.textContent = 'If that email exists, a reset link has been sent.';
        forgotMessage.style.display = 'block';
      };
    }

    if (resetForm) {
      resetForm.onsubmit = async (e) => {
        e.preventDefault();
        if (!resetToken) return;

        const newPassword = (document.getElementById('reset-password') as HTMLInputElement).value;
        if (newPassword.length < 8) {
          queryMessageEl.textContent = 'Password must be at least 8 characters.';
          queryMessageEl.style.display = 'block';
          return;
        }

        try {
          const res = await fetch('/v1/user/auth/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: resetToken, new_password: newPassword }),
          });
          if (!res.ok) {
            const payload = await res.json().catch(() => ({}));
            throw new Error(payload?.detail || 'Password reset failed');
          }
          queryMessageEl.textContent = 'Password reset successfully. Log in with your new password.';
          queryMessageEl.style.display = 'block';
          resetPanel.style.display = 'none';
          const clean = new URL(window.location.href);
          clean.searchParams.delete('reset_token');
          window.history.replaceState({}, '', clean.toString());
        } catch (err) {
          queryMessageEl.textContent = err instanceof Error ? err.message : 'Password reset failed';
          queryMessageEl.style.display = 'block';
        }
      };
    }
  }

  document.addEventListener('astro:page-load', initLoginPage);
  initLoginPage();
</script>

<style>
  .auth-container {
    max-width: 400px;
    margin: 2rem auto;
    padding: 0 1.5rem;
  }

  .auth-title {
    font-family: var(--font-sans);
    font-size: 0.85rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--accent);
    text-align: center;
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  .auth-subtitle {
    font-family: var(--font-sans);
    font-size: 0.7rem;
    color: var(--text-muted);
    text-align: center;
    margin-bottom: 1.5rem;
    letter-spacing: 0.1em;
  }

  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .form-group label {
    font-family: var(--font-sans);
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  .form-group input {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--text-ghost);
    color: var(--text-primary);
    padding: 0.75rem 1rem;
    font-family: var(--font-sans);
    font-size: 0.85rem;
    border-radius: 2px;
    transition: border-color 0.3s ease;
  }

  .form-group input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .error-message {
    font-family: var(--font-sans);
    font-size: 0.75rem;
    color: #c45;
    text-align: center;
    padding: 0.5rem;
  }

  .success-message {
    font-family: var(--font-sans);
    font-size: 0.75rem;
    color: var(--accent);
    text-align: center;
    padding: 0.5rem;
  }

  .auth-button {
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    padding: 0.85rem;
    font-family: var(--font-sans);
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 0.5rem;
  }

  .auth-button:hover {
    background: var(--accent-glow);
  }

  .forgot-link {
    text-align: right;
    margin-top: 0.5rem;
    font-family: var(--font-sans);
    font-size: 0.7rem;
  }

  .forgot-link a {
    color: var(--text-muted);
  }

  .auth-divider {
    display: flex;
    align-items: center;
    margin: 2rem 0;
    gap: 1rem;
  }

  .auth-divider::before,
  .auth-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--text-ghost);
  }

  .auth-divider span {
    font-family: var(--font-sans);
    font-size: 0.65rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.15em;
  }

  .oauth-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    align-items: center;
  }

  .oauth-google-slot {
    min-height: 44px;
    width: min(100%, 344px);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .oauth-button {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--text-ghost);
    color: var(--text-secondary);
    padding: 0.75rem;
    font-family: var(--font-sans);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 4px;
  }

  .oauth-button:hover {
    border-color: var(--text-muted);
    color: var(--text-primary);
  }

  .oauth-apple {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
    width: min(100%, 344px);
    min-height: 40px;
    height: 40px;
    padding: 0 12px;
    background: #fff;
    border-color: rgba(255, 255, 255, 0.9);
    color: #1f1f1f;
    font-weight: 500;
  }

  .oauth-apple:hover {
    background: #f2f2f2;
    border-color: #fff;
    color: #111;
  }

  .oauth-apple-logo {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex: 0 0 14px;
    width: 14px;
    height: 14px;
    transform: translateY(-0.5px);
  }

  .oauth-apple-logo svg {
    width: 100%;
    height: 100%;
    fill: currentColor;
  }

  .auth-link {
    text-align: center;
    margin-top: 2rem;
    font-family: var(--font-sans);
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .auth-link a {
    color: var(--accent);
  }

  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }

  .modal-content {
    background: var(--surface);
    border: 1px solid var(--text-ghost);
    padding: 2rem;
    max-width: 400px;
    width: 90%;
  }

  .modal-title {
    font-family: var(--font-sans);
    font-size: 0.75rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 1.5rem;
    font-weight: 500;
  }

  .cancel-button {
    background: transparent;
    border: 1px solid var(--text-ghost);
    color: var(--text-muted);
    padding: 0.75rem;
    font-family: var(--font-sans);
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    cursor: pointer;
    margin-top: 0.5rem;
    width: 100%;
    transition: all 0.3s ease;
  }

  .cancel-button:hover {
    border-color: var(--text-muted);
  }
</style>
