---
import Base from '../layouts/Base.astro';
import Background from '../components/Background.svelte';
---

<Base title="Register">
  <Background />

  <header class="site-header">
    <div class="site-title"><a href="/">VOIDWIRE</a></div>
    <nav class="site-nav">
      <a href="/archive">Archive</a>
      <a href="/events">Events</a>
      <a href="/about">About</a>
    </nav>
  </header>

  <main>
    <div class="auth-container">
      <h1 class="auth-title">Create Account</h1>
      <p class="auth-subtitle">Begin receiving personalized readings</p>

      <form id="register-form" class="auth-form">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required autocomplete="email" />
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required minlength="8" autocomplete="new-password" />
        </div>

        <div class="form-group">
          <label for="confirm-password">Confirm Password</label>
          <input type="password" id="confirm-password" name="confirm-password" required minlength="8" autocomplete="new-password" />
        </div>

        <div class="form-group">
          <label for="display-name">Display Name <span class="optional">(optional)</span></label>
          <input type="text" id="display-name" name="display-name" autocomplete="name" />
        </div>

        <div id="error-message" class="error-message" style="display: none;"></div>

        <button type="submit" class="auth-button">Register</button>
      </form>

      <div id="oauth-section" style="display: none;">
        <div class="auth-divider"><span>or continue with</span></div>
        <div class="oauth-buttons">
          <div id="oauth-google-button" style="display: none;"></div>
          <button type="button" id="oauth-apple-button" class="oauth-button" style="display: none;">
            Continue with Apple
          </button>
        </div>
      </div>

      <p class="auth-link">Already have an account? <a href="/login">Login</a></p>
    </div>
  </main>
</Base>

<script>
  import { setToken } from '../utils/auth';

  type OAuthProviders = {
    google?: { enabled?: boolean; client_id?: string };
    apple?: { enabled?: boolean; client_id?: string };
  };

  function loadExternalScript(src: string, isReady: () => boolean): Promise<void> {
    return new Promise((resolve, reject) => {
      if (isReady()) {
        resolve();
        return;
      }
      const selector = `script[data-oauth-src="${src}"]`;
      let script = document.querySelector(selector) as HTMLScriptElement | null;

      const resolveWhenReady = () => {
        if (isReady()) {
          if (script) {
            script.dataset.loaded = 'true';
          }
          resolve();
          return;
        }
        window.setTimeout(() => {
          if (isReady()) {
            if (script) {
              script.dataset.loaded = 'true';
            }
            resolve();
            return;
          }
          reject(new Error(`Failed to initialize ${src}`));
        }, 100);
      };

      if (script) {
        if (script.dataset.loaded === 'true') {
          resolveWhenReady();
          return;
        }
        script.addEventListener('load', resolveWhenReady, { once: true });
        script.addEventListener('error', () => reject(new Error(`Failed to load ${src}`)), {
          once: true,
        });
        return;
      }

      script = document.createElement('script');
      script.src = src;
      script.async = true;
      script.defer = true;
      script.dataset.oauthSrc = src;
      script.addEventListener('load', resolveWhenReady, { once: true });
      script.addEventListener('error', () => reject(new Error(`Failed to load ${src}`)), {
        once: true,
      });
      document.head.appendChild(script);
    });
  }

  async function completeOauthLogin(path: string, payload: Record<string, unknown>): Promise<void> {
    const res = await fetch(path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data?.detail || 'OAuth registration failed');
    }
    const data = await res.json();
    setToken(data.access_token);
    window.location.href = '/dashboard';
  }

  function initRegisterPage(): void {
    if (window.location.pathname !== '/register') return;

    const form = document.getElementById('register-form') as HTMLFormElement | null;
    const errorEl = document.getElementById('error-message') as HTMLDivElement | null;
    const oauthSectionEl = document.getElementById('oauth-section') as HTMLDivElement | null;
    const googleButtonMount = document.getElementById('oauth-google-button') as HTMLDivElement | null;
    const appleButtonEl = document.getElementById('oauth-apple-button') as HTMLButtonElement | null;
    if (!form || !errorEl) return;

    let oauthInFlight = false;

    function showAuthError(message: string): void {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    function clearAuthError(): void {
      errorEl.style.display = 'none';
    }

    async function setupGoogleOauth(clientId: string): Promise<void> {
      if (!googleButtonMount) return;
      await loadExternalScript(
        'https://accounts.google.com/gsi/client',
        () => Boolean((window as any).google?.accounts?.id),
      );
      const googleApi = (window as any).google;
      if (!googleApi?.accounts?.id) {
        throw new Error('Google OAuth SDK failed to load');
      }
      googleButtonMount.style.display = 'block';
      googleButtonMount.innerHTML = '';
      googleApi.accounts.id.initialize({
        client_id: clientId,
        callback: async (response: any) => {
          const credential = String(response?.credential || '').trim();
          if (!credential) {
            showAuthError('Google sign-in did not return a credential');
            return;
          }
          if (oauthInFlight) return;
          oauthInFlight = true;
          clearAuthError();
          try {
            await completeOauthLogin('/v1/user/auth/oauth/google', { id_token: credential });
          } catch (err) {
            showAuthError(err instanceof Error ? err.message : 'Google sign-in failed');
          } finally {
            oauthInFlight = false;
          }
        },
      });
      googleApi.accounts.id.renderButton(googleButtonMount, {
        theme: 'outline',
        size: 'large',
        text: 'continue_with',
        width: 320,
      });
    }

    async function setupAppleOauth(clientId: string): Promise<void> {
      if (!appleButtonEl) return;
      await loadExternalScript(
        'https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js',
        () => Boolean((window as any).AppleID?.auth),
      );
      const appleApi = (window as any).AppleID;
      if (!appleApi?.auth) {
        throw new Error('Apple OAuth SDK failed to load');
      }
      appleApi.auth.init({
        clientId,
        scope: 'name email',
        redirectURI: `${window.location.origin}/login`,
        usePopup: true,
      });
      appleButtonEl.style.display = 'block';
      appleButtonEl.onclick = async () => {
        if (oauthInFlight) return;
        oauthInFlight = true;
        clearAuthError();
        try {
          const authResponse = await appleApi.auth.signIn();
          const code = String(authResponse?.authorization?.code || '').trim();
          if (!code) {
            throw new Error('Apple sign-in did not return an authorization code');
          }
          await completeOauthLogin('/v1/user/auth/oauth/apple', { authorization_code: code });
        } catch (err: any) {
          if (String(err?.error || '').toLowerCase() === 'popup_closed_by_user') {
            showAuthError('Apple sign-in was cancelled');
          } else {
            showAuthError(err instanceof Error ? err.message : 'Apple sign-in failed');
          }
        } finally {
          oauthInFlight = false;
        }
      };
    }

    async function loadOauthState() {
      try {
        const res = await fetch('/v1/user/auth/oauth/providers');
        if (!res.ok) return;
        const providers = (await res.json()) as OAuthProviders;
        const googleEnabled = Boolean(providers?.google?.enabled);
        const appleEnabled = Boolean(providers?.apple?.enabled);
        if (!googleEnabled && !appleEnabled) return;
        if (oauthSectionEl) {
          oauthSectionEl.style.display = 'block';
        }
        if (googleEnabled) {
          const googleClientId = String(providers?.google?.client_id || '').trim();
          if (googleClientId) {
            await setupGoogleOauth(googleClientId);
          } else {
            showAuthError('Google OAuth is enabled but missing client ID');
          }
        }
        if (appleEnabled) {
          const appleClientId = String(providers?.apple?.client_id || '').trim();
          if (appleClientId) {
            await setupAppleOauth(appleClientId);
          } else {
            showAuthError('Apple OAuth is enabled but missing client ID');
          }
        }
      } catch {
        // Leave OAuth section hidden when provider status cannot be loaded.
      }
    }

    void loadOauthState();

    form.onsubmit = async (e) => {
      e.preventDefault();
      clearAuthError();

      const email = (document.getElementById('email') as HTMLInputElement).value;
      const password = (document.getElementById('password') as HTMLInputElement).value;
      const confirmPassword = (document.getElementById('confirm-password') as HTMLInputElement).value;
      const displayName = (document.getElementById('display-name') as HTMLInputElement).value;

      if (password !== confirmPassword) {
        showAuthError('Passwords do not match');
        return;
      }

      try {
        const res = await fetch('/v1/user/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            password,
            display_name: displayName || null,
          }),
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.detail || 'Registration failed');
        }

        const data = await res.json();
        setToken(data.access_token);
        window.location.href = '/dashboard';
      } catch (err) {
        showAuthError(err instanceof Error ? err.message : 'Registration failed');
      }
    };
  }

  document.addEventListener('astro:page-load', initRegisterPage);
  initRegisterPage();
</script>

<style>
  .auth-container {
    max-width: 400px;
    margin: 2rem auto;
    padding: 0 1.5rem;
  }

  .auth-title {
    font-family: var(--font-sans);
    font-size: 0.85rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--accent);
    text-align: center;
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  .auth-subtitle {
    font-family: var(--font-sans);
    font-size: 0.7rem;
    color: var(--text-muted);
    text-align: center;
    margin-bottom: 1.5rem;
    letter-spacing: 0.1em;
  }

  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .form-group label {
    font-family: var(--font-sans);
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  .optional {
    color: var(--text-ghost);
    text-transform: none;
    letter-spacing: 0;
  }

  .form-group input {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--text-ghost);
    color: var(--text-primary);
    padding: 0.75rem 1rem;
    font-family: var(--font-sans);
    font-size: 0.85rem;
    border-radius: 2px;
    transition: border-color 0.3s ease;
  }

  .form-group input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .error-message {
    font-family: var(--font-sans);
    font-size: 0.75rem;
    color: #c45;
    text-align: center;
    padding: 0.5rem;
  }

  .auth-button {
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    padding: 0.85rem;
    font-family: var(--font-sans);
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 0.5rem;
  }

  .auth-button:hover {
    background: var(--accent-glow);
  }

  .auth-divider {
    display: flex;
    align-items: center;
    margin: 2rem 0;
    gap: 1rem;
  }

  .auth-divider::before,
  .auth-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--text-ghost);
  }

  .auth-divider span {
    font-family: var(--font-sans);
    font-size: 0.65rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.15em;
  }

  .oauth-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .oauth-button {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--text-ghost);
    color: var(--text-secondary);
    padding: 0.75rem;
    font-family: var(--font-sans);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .oauth-button:hover {
    border-color: var(--text-muted);
    color: var(--text-primary);
  }

  .auth-link {
    text-align: center;
    margin-top: 2rem;
    font-family: var(--font-sans);
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .auth-link a {
    color: var(--accent);
  }

</style>
