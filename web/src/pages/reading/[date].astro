---
import Base from '../../layouts/Base.astro';
import Reading from '../../components/Reading.astro';
import TransitWheel from '../../components/TransitWheel.svelte';
import Background from '../../components/Background.svelte';
import { apiUrl, forwardedApiHeaders } from '../../utils/api';

const { date: dateParam } = Astro.params;

let reading: any = null;
let ephemeris: any = null;
let error: string | null = null;
let notFound = false;

// Set 404 status when reading not found (checked after API call below)
const apiHeaders = forwardedApiHeaders(Astro.clientAddress);

try {
  const res = await fetch(apiUrl(`/v1/reading/${dateParam}`), { headers: apiHeaders });
  if (res.ok) {
    reading = await res.json();
  } else if (res.status === 404) {
    notFound = true;
  } else {
    error = `Unexpected status: ${res.status}`;
  }
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error';
}

if (notFound) {
  Astro.response.status = 404;
}

if (reading) {
  try {
    const res = await fetch(apiUrl(`/v1/ephemeris/${dateParam}`), { headers: apiHeaders });
    if (res.ok) {
      ephemeris = await res.json();
    }
  } catch {}
}

const aspects = ephemeris?.aspects || [];
const positions = ephemeris?.positions || {};
const pageTitle = reading ? reading.title : `Reading for ${dateParam}`;
const extended = reading?.extended || null;
const showExtended = !!(extended && Array.isArray(extended.sections) && extended.sections.length > 0);

function refineTypography(text: string) {
  return text
    .replace(/\.\.\./g, '&hellip;')
    .replace(/--/g, '&mdash;')
    .replace(/(^|[-\s(\[<{])"/g, '$1&ldquo;')
    .replace(/"/g, '&rdquo;')
    .replace(/(^|[-\s(\[<{])'/g, '$1&lsquo;')
    .replace(/'/g, '&rsquo;');
}

function formatBody(text: string): string {
  return text
    .split(/\n\n+/)
    .filter((p: string) => p.trim().length > 0)
    .map((p: string) => `<p>${refineTypography(p.trim())}</p>`)
    .join('\n');
}

// Structured data (JSON-LD)
const jsonLd = reading ? JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: reading.title,
  datePublished: reading.date_context,
  dateModified: reading.date_context,
  description: reading.body ? reading.body.substring(0, 200).replace(/\n/g, ' ').trim() : undefined,
  wordCount: reading.word_count || undefined,
  image: `https://voidwireastro.com/og/${dateParam}.png`,
  author: { '@type': 'Organization', name: 'VOIDWIRE' },
  publisher: { '@type': 'Organization', name: 'VOIDWIRE' },
  mainEntityOfPage: { '@type': 'WebPage', '@id': `/reading/${dateParam}` },
}) : null;
---

<Base title={pageTitle} ogImage={`/og/${dateParam}.png`}>
  {jsonLd && <script type="application/ld+json" set:html={jsonLd} />}
  <Background />
  <div class="reading-progress"></div>

  <header class="site-header">
    <div class="site-title"><a href="/">VOIDWIRE</a></div>
    <nav class="site-nav">
      <a href="/archive">Archive</a>
      <a href="/events">Events</a>
      <a href="/about">About</a>
    </nav>
  </header>

  <main>
    {reading && (
      <Reading
        title={reading.title}
        body={reading.body}
        date_context={reading.date_context}
        word_count={reading.word_count}
        has_extended={false}
      />
    )}

    {reading && showExtended && (
      <section class="extended-content" data-reveal>
        <div class="section-divider"></div>

        {extended.sections.map((section: any) => (
          <article class="extended-block">
            {section.heading && <h3 class="extended-heading">{section.heading}</h3>}
            <div class="extended-body" set:html={formatBody(section.body)} />
          </article>
        ))}
      </section>
    )}

    {reading && aspects.length > 0 && (
      <section class="transit-visualization" data-reveal>
        <div class="section-label">Celestial Geometry</div>
        <TransitWheel positions={positions} aspects={aspects} client:visible />
      </section>
    )}

    {reading && reading.annotations && reading.annotations.length > 0 && (
      <section class="annotations-section" data-reveal>
        <div class="section-label">Annotations</div>
        <div class="annotations-list">
          {reading.annotations.map((a: any) => (
            <div class="annotation-item">
              <div class="annotation-aspect">{a.aspect}</div>
              <div class="annotation-gloss" set:html={refineTypography(a.gloss)} />
              {a.cultural_resonance && (
                <div class="annotation-resonance" set:html={refineTypography(a.cultural_resonance)} />
              )}
            </div>
          ))}
        </div>
      </section>
    )}

    {notFound && (
      <div class="void-page">
        <div class="void-container">
          <div class="void-sigil">
            <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" class="sigil-svg" aria-hidden="true">
              <circle cx="60" cy="60" r="56" fill="none" stroke="var(--accent)" stroke-width="0.5" opacity="0.3" />
              <circle cx="60" cy="60" r="40" fill="none" stroke="var(--accent)" stroke-width="0.3" opacity="0.2" />
              <circle cx="60" cy="60" r="22" fill="none" stroke="var(--accent)" stroke-width="0.3" opacity="0.15" />
              <line x1="60" y1="2" x2="60" y2="118" stroke="var(--accent)" stroke-width="0.3" opacity="0.12" />
              <line x1="2" y1="60" x2="118" y2="60" stroke="var(--accent)" stroke-width="0.3" opacity="0.12" />
              <circle cx="60" cy="60" r="3" fill="var(--accent)" opacity="0.15" />
            </svg>
          </div>
          <div class="void-code">404</div>
          <h1 class="void-title">No transmission found</h1>
          <p class="void-body">
            No reading exists for {dateParam}. The wire was silent on this frequency.
          </p>
          <div class="void-divider"></div>
          <nav class="void-nav">
            <a href="/">Today&rsquo;s Reading</a>
            <span class="void-sep">&middot;</span>
            <a href="/archive">Archive</a>
          </nav>
        </div>
      </div>
    )}
  </main>
</Base>

<style>
  .section-divider {
    max-width: 100px;
    height: 1px;
    background: var(--text-ghost);
    margin: 3rem auto;
  }

  .section-label {
    font-family: var(--font-sans);
    font-size: 0.6rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--text-muted);
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .extended-content {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 1.5rem 3rem;
  }

  .extended-block {
    margin-bottom: 2.5rem;
  }

  .extended-heading {
    font-family: var(--font-sans);
    font-size: 0.75rem;
    color: var(--accent);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 1rem;
    font-weight: 500;
  }

  .extended-body {
    font-size: 1.25rem;
    line-height: 1.8;
    color: var(--text-primary);
  }

  .extended-body :global(p) {
    margin-bottom: 1.5em;
  }

  .extended-body :global(p:last-child) {
    margin-bottom: 0;
  }

  .transit-visualization {
    max-width: 1000px;
    margin: 3rem auto;
    padding: 0 1.5rem;
  }

  .annotations-section {
    max-width: var(--max-width);
    margin: 3rem auto;
    padding: 0 1.5rem 4rem;
  }

  .annotations-list {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
  }

  .annotation-item {
    padding-left: 1.25rem;
    border-left: 2px solid var(--accent);
    position: relative;
  }

  .annotation-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -2px;
    width: 2px;
    height: 100%;
    background: linear-gradient(180deg, var(--accent), transparent);
    opacity: 0.4;
  }

  .annotation-aspect {
    font-family: var(--font-sans);
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 0.75rem;
    opacity: 0.85;
  }

  .annotation-gloss {
    font-size: 1.15rem;
    line-height: 1.75;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
  }

  .annotation-resonance {
    font-size: 0.95rem;
    color: var(--text-muted);
    font-style: italic;
    line-height: 1.7;
    margin-top: 0.5rem;
    padding-left: 1rem;
    border-left: 1px solid var(--text-ghost);
  }

  .void-page {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: calc(100vh - 8rem);
    padding: 2rem 1.5rem;
  }

  .void-container {
    text-align: center;
    max-width: 480px;
  }

  .void-sigil {
    width: 100px;
    height: 100px;
    margin: 0 auto 2rem;
    animation: sigil-drift 16s ease-in-out infinite, sigil-fade-in 2s ease-out both;
  }

  .sigil-svg {
    width: 100%;
    height: 100%;
  }

  @keyframes sigil-drift {
    0%, 100% { transform: rotate(0deg); }
    50% { transform: rotate(180deg); }
  }

  @keyframes sigil-fade-in {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
  }

  .void-code {
    font-family: var(--font-mono);
    font-size: 0.6rem;
    letter-spacing: 0.4em;
    color: var(--text-ghost);
    margin-bottom: 1.25rem;
    animation: void-in 1.5s ease-out 0.3s both;
  }

  .void-title {
    font-family: var(--font-body);
    font-size: 1.8rem;
    font-weight: 400;
    color: var(--text-primary);
    line-height: 1.3;
    margin-bottom: 1.25rem;
    animation: void-in 1.5s ease-out 0.5s both;
  }

  .void-body {
    font-family: var(--font-body);
    font-size: 1rem;
    line-height: 1.8;
    color: var(--text-secondary);
    margin-bottom: 2rem;
    animation: void-in 1.5s ease-out 0.7s both;
  }

  .void-divider {
    width: 50px;
    height: 1px;
    background: var(--text-ghost);
    margin: 0 auto 1.5rem;
    animation: void-in 1.5s ease-out 0.9s both;
  }

  .void-nav {
    font-family: var(--font-sans);
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    animation: void-in 1.5s ease-out 1.1s both;
  }

  .void-nav a { color: var(--text-muted); transition: color 0.3s ease; }
  .void-nav a:hover { color: var(--accent); opacity: 1; }
  .void-sep { color: var(--text-ghost); font-size: 0.5rem; }

  @keyframes void-in {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (prefers-reduced-motion: reduce) {
    .void-sigil, .void-code, .void-title, .void-body, .void-divider, .void-nav {
      animation: none;
    }
  }
</style>
