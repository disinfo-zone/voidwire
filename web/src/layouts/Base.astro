---
interface Props {
  title?: string;
  description?: string;
  canonicalPath?: string;
  ogImage?: string;
}

const { title, description, canonicalPath, ogImage } = Astro.props;

import { ViewTransitions } from 'astro:transitions';
import '../styles/global.css';
import { apiUrl, forwardedApiHeaders } from '../utils/api';

type SiteConfig = {
  site_title: string;
  tagline: string;
  site_url: string;
  timezone: string;
  favicon_url: string;
  meta_description: string;
  og_image_url: string;
  og_title_template: string;
  twitter_handle: string;
  tracking_head: string;
  tracking_body: string;
};

const defaultSiteConfig: SiteConfig = {
  site_title: 'VOIDWIRE',
  tagline: 'Daily transmissions from the celestial wire.',
  site_url: 'http://localhost',
  timezone: 'UTC',
  favicon_url: '',
  meta_description: 'Daily transmissions from the celestial wire.',
  og_image_url: '',
  og_title_template: '{{title}} | {{site_title}}',
  twitter_handle: '',
  tracking_head: '',
  tracking_body: '',
};

let siteConfig: SiteConfig = defaultSiteConfig;
const apiHeaders = forwardedApiHeaders(Astro.clientAddress);
try {
  const res = await fetch(apiUrl('/v1/site/config'), { headers: apiHeaders });
  if (res.ok) {
    const data = await res.json();
    siteConfig = { ...defaultSiteConfig, ...data };
  }
} catch {
  siteConfig = defaultSiteConfig;
}

let isLoggedIn = false;
try {
  const requestCookies = Astro.request.headers.get('cookie');
  if (requestCookies) {
    const authHeaders = new Headers(apiHeaders ?? {});
    authHeaders.set('cookie', requestCookies);
    const authRes = await fetch(apiUrl('/v1/user/auth/me'), {
      headers: authHeaders,
      cache: 'no-store',
    });
    isLoggedIn = authRes.ok;
  }
} catch {
  isLoggedIn = false;
}

const siteTitle = String(siteConfig.site_title || defaultSiteConfig.site_title).trim() || 'VOIDWIRE';
const pageTitle = title ? `${title} | ${siteTitle}` : siteTitle;
const pageDescription =
  description ||
  String(siteConfig.meta_description || siteConfig.tagline || defaultSiteConfig.meta_description).trim();

const faviconUrl = String(siteConfig.favicon_url || '').trim() || '/favicon.ico';
const ogTemplate = String(siteConfig.og_title_template || '{{title}} | {{site_title}}');
const ogTitle = ogTemplate
  .replaceAll('{{title}}', title ? String(title) : siteTitle)
  .replaceAll('{{site_title}}', siteTitle);

let canonicalUrl = '';
try {
  const base = String(siteConfig.site_url || defaultSiteConfig.site_url).trim();
  const path = String(canonicalPath || Astro.url.pathname || '/');
  canonicalUrl = new URL(path, base).toString();
} catch {
  canonicalUrl = '';
}

function resolveCurrentNavHref(pathname: string): string | null {
  const path = String(pathname || '/').trim();
  if (path === '/archive' || path.startsWith('/archive/')) return '/archive';
  if (path === '/events' || path.startsWith('/events/')) return '/events';
  if (path === '/about' || path.startsWith('/about/')) return '/about';
  if (path === '/dashboard' || path.startsWith('/dashboard/')) return '/dashboard';
  return null;
}

const currentNavHref = resolveCurrentNavHref(Astro.url.pathname);

const rawOgImage = ogImage || String(siteConfig.og_image_url || '').trim();
let ogImageUrl = rawOgImage;
// Social crawlers need absolute URLs — resolve relative paths against site_url
if (ogImageUrl && !ogImageUrl.startsWith('http')) {
  try {
    const base = String(siteConfig.site_url || defaultSiteConfig.site_url).trim();
    ogImageUrl = new URL(ogImageUrl, base).toString();
  } catch {}
}
const twitterHandle = String(siteConfig.twitter_handle || '').trim();
const trackingHeadRaw = String(siteConfig.tracking_head || '');
const trackingBodyRaw = String(siteConfig.tracking_body || '');
const allowUnsafeTrackingSnippets =
  String(process.env.ALLOW_UNSAFE_TRACKING_SNIPPETS || import.meta.env.ALLOW_UNSAFE_TRACKING_SNIPPETS || '')
    .trim()
    .toLowerCase() === 'true';
const TRACKING_ALLOWED_TAGS = new Set(['script', 'noscript', 'iframe', 'img', 'div', 'span', 'a']);

function isSafeTrackingUrl(value: string): boolean {
  const raw = String(value || '').trim();
  if (!raw) return false;
  if (raw.startsWith('/')) return true;
  try {
    const parsed = new URL(raw);
    if (parsed.protocol === 'https:') return true;
    if (parsed.protocol === 'http:' && (parsed.hostname === 'localhost' || parsed.hostname === '127.0.0.1')) {
      return true;
    }
    return false;
  } catch {
    return false;
  }
}

function sanitizeTrackingSnippet(raw: string): string {
  const value = String(raw || '').trim();
  if (!value) return '';
  if (allowUnsafeTrackingSnippets) return value;
  if (/(on[a-z]+\s*=|javascript:|<\s*(object|embed|svg|math)\b)/i.test(value)) return '';

  const tagPattern = /<\/?([a-z0-9-]+)\b[^>]*>/gi;
  let tagMatch: RegExpExecArray | null;
  while ((tagMatch = tagPattern.exec(value)) !== null) {
    const tag = String(tagMatch[1] || '').toLowerCase();
    if (!TRACKING_ALLOWED_TAGS.has(tag)) return '';
  }

  const scriptPattern = /<script\b([^>]*)>([\s\S]*?)<\/script>/gi;
  let sawScript = false;
  let scriptMatch: RegExpExecArray | null;
  while ((scriptMatch = scriptPattern.exec(value)) !== null) {
    sawScript = true;
    const attrs = String(scriptMatch[1] || '');
    const body = String(scriptMatch[2] || '');
    const srcMatch = attrs.match(/\bsrc\s*=\s*["']([^"']+)["']/i);
    if (!srcMatch) return '';
    if (body.trim()) return '';
    if (!isSafeTrackingUrl(srcMatch[1])) return '';
  }
  if (/<script\b/i.test(value) && !sawScript) return '';

  const resourcePattern = /\b(?:src|href)\s*=\s*["']([^"']+)["']/gi;
  let resourceMatch: RegExpExecArray | null;
  while ((resourceMatch = resourcePattern.exec(value)) !== null) {
    if (!isSafeTrackingUrl(resourceMatch[1])) return '';
  }

  return value;
}

const trackingHead = sanitizeTrackingSnippet(trackingHeadRaw);
const trackingBody = sanitizeTrackingSnippet(trackingBodyRaw);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={pageDescription} />
    <meta name="theme-color" content="#050505" />
    <title>{pageTitle}</title>
    <link rel="icon" href={faviconUrl} />
    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}
    <meta property="og:title" content={ogTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content="website" />
    {canonicalUrl && <meta property="og:url" content={canonicalUrl} />}
    {ogImageUrl && <meta property="og:image" content={ogImageUrl} />}
    {ogImageUrl && <meta property="og:image:width" content="1200" />}
    {ogImageUrl && <meta property="og:image:height" content="630" />}
    {ogImageUrl && <meta property="og:image:type" content="image/png" />}
    <meta name="twitter:card" content={ogImageUrl ? 'summary_large_image' : 'summary'} />
    <meta name="twitter:title" content={ogTitle} />
    <meta name="twitter:description" content={pageDescription} />
    {twitterHandle && <meta name="twitter:site" content={twitterHandle} />}
    {ogImageUrl && <meta name="twitter:image" content={ogImageUrl} />}

    <!-- Google Fonts: preconnect + preload CSS for faster first paint -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500&family=JetBrains+Mono:wght@300;400&display=swap"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500&family=JetBrains+Mono:wght@300;400&display=swap"
      rel="stylesheet"
    />

    <!-- Feeds -->
    <link rel="alternate" type="application/rss+xml" title="VOIDWIRE RSS" href="/feed.xml" />
    <link rel="alternate" type="application/atom+xml" title="VOIDWIRE Atom" href="/feed.atom" />
    {currentNavHref && (
      <style
        is:inline
        set:html={`
          .site-nav a[href="${currentNavHref}"] {
            color: var(--accent);
            pointer-events: none;
            cursor: default;
            opacity: 1;
            text-decoration: none;
          }
          .site-nav a[href="${currentNavHref}"]:hover {
            color: var(--accent);
            opacity: 1;
          }
        `}
      />
    )}
    {trackingHead && <Fragment set:html={trackingHead} />}
    <ViewTransitions />
  </head>
  <body>
    <slot />
    <footer class="legal-footer">
      <a href="/privacy">Privacy</a>
      <span>•</span>
      <a href="/terms">Terms</a>
      {isLoggedIn && (
        <>
          <span>•</span>
          <a href="/billing-policy">Billing</a>
        </>
      )}
      <span>•</span>
      <a href="/disclaimer">Disclaimer</a>
    </footer>
    <script is:inline>
      (function() {
        var _progressHandler = null;

        function initReveal() {
          document.documentElement.classList.add('js-reveal');
          var els = document.querySelectorAll('[data-reveal]:not(.revealed)');
          if (!els.length) return;
          if (!('IntersectionObserver' in window)) {
            els.forEach(function(el) { el.classList.add('revealed'); });
            return;
          }
          var ob = new IntersectionObserver(function(entries) {
            entries.forEach(function(e) {
              if (e.isIntersecting) {
                e.target.classList.add('revealed');
                ob.unobserve(e.target);
              }
            });
          }, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });
          els.forEach(function(el) { ob.observe(el); });
        }

        function initProgress() {
          if (_progressHandler) {
            window.removeEventListener('scroll', _progressHandler);
            _progressHandler = null;
          }
          var bar = document.querySelector('.reading-progress');
          if (!bar) return;
          var main = document.querySelector('main');
          if (!main) return;
          _progressHandler = function() {
            var docHeight = document.documentElement.scrollHeight - window.innerHeight;
            var pct = docHeight > 0 ? Math.min(100, Math.max(0, (window.scrollY / docHeight) * 100)) : 0;
            bar.style.width = pct + '%';
            bar.classList.toggle('visible', pct > 0 && pct < 100);
          };
          window.addEventListener('scroll', _progressHandler, { passive: true });
          _progressHandler();
        }

        function initNavSelfLinkGuard() {
          var navLinks = document.querySelectorAll('.site-nav a');
          if (!navLinks.length) return;
          navLinks.forEach(function(link) {
            if (link.dataset.selfNavGuarded === '1') return;
            link.dataset.selfNavGuarded = '1';
            link.addEventListener('click', function(event) {
              if (event.defaultPrevented) return;
              if (event.button !== 0 || event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return;
              var href = link.getAttribute('href');
              if (!href || href.startsWith('#')) return;
              var target = link.getAttribute('target');
              if (target && target !== '_self') return;
              try {
                var url = new URL(link.href, window.location.href);
                if (url.origin !== window.location.origin) return;
                if (url.pathname === window.location.pathname && url.search === window.location.search && !url.hash) {
                  event.preventDefault();
                }
              } catch (_) {}
            });
          });
        }

        function initCurrentNavAria() {
          var current = window.location.pathname;
          document.querySelectorAll('.site-nav a[aria-current="page"]').forEach(function(link) {
            link.removeAttribute('aria-current');
          });
          document.querySelectorAll('.site-nav a').forEach(function(link) {
            var href = link.getAttribute('href');
            if (href && href === current) {
              link.setAttribute('aria-current', 'page');
            }
          });
        }

        function initAll() { initReveal(); initProgress(); initCurrentNavAria(); initNavSelfLinkGuard(); }
        initAll();
        document.addEventListener('astro:page-load', initAll);
      })();
    </script>
    <script is:inline>
      (() => {
        var _authUser = null;
        function injectDashboardLink() {
          var navs = document.querySelectorAll('.site-nav');
          if (!navs.length) return;
          var onDashboard = window.location.pathname === '/dashboard';
          if (onDashboard) {
            navs.forEach(function(nav) {
              nav.querySelectorAll('a[href="/dashboard"]').forEach(function(link) { link.remove(); });
            });
            return;
          }
          if (_authUser) {
            navs.forEach(function(nav) {
              if (nav.querySelector('a[href="/dashboard"]')) return;
              var link = document.createElement('a');
              link.href = '/dashboard';
              link.textContent = 'Dashboard';
              if (window.location.pathname === '/dashboard') {
                link.setAttribute('aria-current', 'page');
              }
              nav.appendChild(link);
            });
          } else if (_authUser === null) {
            fetch('/v1/user/auth/me', { credentials: 'include' })
              .then(function(res) { return res.ok ? res.json() : null; })
              .then(function(me) {
                _authUser = me?.id ? me : false;
                if (_authUser) injectDashboardLink();
              })
              .catch(function() { _authUser = false; });
          }
        }
        injectDashboardLink();
        document.addEventListener('astro:page-load', injectDashboardLink);
      })();
    </script>
    {trackingBody && <Fragment set:html={trackingBody} />}
  </body>
</html>
